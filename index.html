import streamlit as st
import pandas as pd
from datetime import datetime
from streamlit_gsheets import GSheetsConnection

# ---------------------------
# CONFIG
# ---------------------------
ROSTER_SHEET = "Roster"
LOG_SHEET = "FormResponses"

STUDENT_ID_COL = "ID"
NAME_COL = "Name"

LOG_ID_COL = "ID"
TIMESTAMP_COL = "Timestamp"

st.set_page_config(page_title="Attendance Dashboard", page_icon="üìã", layout="wide")

st.title("üìã Live Attendance Dashboard")

# ---------------------------
# GOOGLE SHEET CONNECTION
# ---------------------------
conn = st.connection("gcp_sheets", type=GSheetsConnection)

# Load sheets
roster_df = conn.read(worksheet=ROSTER_SHEET)
log_df = conn.read(worksheet=LOG_SHEET)

# Clean data
roster_df.dropna(subset=[STUDENT_ID_COL], inplace=True)
roster_df[STUDENT_ID_COL] = roster_df[STUDENT_ID_COL].astype(str).str.strip()

log_df[LOG_ID_COL] = log_df[LOG_ID_COL].astype(str).str.strip()
log_df[TIMESTAMP_COL] = pd.to_datetime(log_df[TIMESTAMP_COL], errors="coerce")

# ---------------------------
# FILTER TODAY'S ATTENDANCE
# ---------------------------
today = datetime.now().date()

log_today = log_df[log_df[TIMESTAMP_COL].dt.date == today]
present_ids = set(log_today[LOG_ID_COL].unique())

# ---------------------------
# PREPARE FINAL ATTENDANCE TABLE
# ---------------------------
attendance_df = roster_df.copy()
attendance_df["Status"] = attendance_df[STUDENT_ID_COL].apply(
    lambda sid: "PRESENT" if sid in present_ids else "ABSENT"
)

present_count = (attendance_df["Status"] == "PRESENT").sum()
total_students = len(attendance_df)

# ---------------------------
# ACTION BUTTONS
# ---------------------------
col1, col2, col3 = st.columns([1, 1, 2])

with col1:
    if st.button("üîÅ Reset TODAY's Attendance"):
        df_without_today = log_df[log_df[TIMESTAMP_COL].dt.date != today]
        conn.update(worksheet=LOG_SHEET, data=df_without_today)
        st.cache_data.clear()
        st.success("Today's attendance has been reset!")
        st.stop()

with col2:
    if st.button("üì∑ Open QR Scanning Page"):
        st.markdown(
            """<script>
                window.open("https://rajasthan11.vercel.app", "_blank").focus();
               </script>""",
            unsafe_allow_html=True
        )

# ---------------------------
# DISPLAY SUMMARY
# ---------------------------
st.subheader(f"Attendance Today ‚Äì {today.strftime('%d %B %Y')}")
st.markdown(f"### üü¢ Present: **{present_count}** / {total_students}")

# ---------------------------
# DISPLAY TABLE
# ---------------------------
st.dataframe(attendance_df, use_container_width=True)

